<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0" />
    <title>Transaction Categorizer v2.0</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2rem;
            background: #f4f4f4;
        }

        .file-upload {
            margin-bottom: 1.5rem;
        }

        .file-upload-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .controls {
            margin: 1.5rem 0;
        }

        button {
            padding: 0.5rem 1rem;
            margin-right: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .button-secondary {
            background-color: #2196F3;
        }

        .button-secondary:hover {
            background-color: #0b7dda;
        }

        .button-danger {
            background-color: #f44336;
        }

        .button-danger:hover {
            background-color: #da190b;
        }

        .section {
            margin-bottom: 2rem;
            background: white;
            padding: 1rem;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            margin-top: 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 1rem 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
            position: sticky;
            top: 0;
        }

        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 2s linear infinite;
            display: none;
            margin-left: 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .hidden {
            display: none;
        }

        select {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 1rem;
        }

        .category-select-container {
            margin-bottom: 1rem;
        }

        .status {
            padding: 0.5rem 1rem;
            margin: 1rem 0;
            border-radius: 4px;
            display: none;
        }

        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        /* Receipt specific styles */
        .receipt-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }

        .receipt-item:hover {
            background-color: #f5f5f5;
        }

        .receipt-original {
            flex: 1;
            font-family: monospace;
            color: #666;
            font-size: 0.9rem;
        }

        .receipt-readable {
            flex: 2;
            padding: 0 1rem;
        }

        .receipt-readable input {
            width: 100%;
            padding: 0.25rem;
            border: 1px solid #ddd;
            border-radius: 3px;
        }

        .receipt-price {
            font-weight: bold;
            min-width: 80px;
            text-align: right;
        }

        .receipt-actions {
            margin-left: 1rem;
        }

        .receipt-actions button {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            margin-left: 0.25rem;
        }

        .receipt-summary {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #333;
            font-size: 1.1rem;
        }

        .receipt-summary .total {
            display: flex;
            justify-content: space-between;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .translation-mappings {
            margin-top: 1rem;
            padding: 1rem;
            background: #f9f9f9;
            border-radius: 4px;
        }

        .mapping-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 3px;
        }

        .mapping-original {
            flex: 1;
            font-family: monospace;
            color: #666;
        }

        .mapping-arrow {
            margin: 0 1rem;
            color: #999;
        }

        .mapping-translation {
            flex: 1;
            font-weight: bold;
        }

        .mapping-delete {
            margin-left: 1rem;
        }

        .add-mapping {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .add-mapping input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 3px;
        }
    </style>
</head>

<body>
    <h1>Transaction Categorizer v2.0</h1>

    <div class="section">
        <h2 class="section-header">User Information</h2>

        <div class="category-select-container">
            <label for="userList">User List:</label>
            <select id="userList">
                <option value="">Loading user lists...</option>
            </select>
            <button id="refreshUsersBtn"
                    class="button-secondary">Refresh Users</button>
        </div>

        <div id="user-status"
             class="status"></div>
    </div>


    <div class="section">
        <h2 class="section-header">Receipts</h2>

        <div class="file-upload">
            <label class="file-upload-label"
                   for="receiptFile">Receipt CSV File:</label>
            <input type="file"
                   id="receiptFile"
                   accept=".csv" />
        </div>

        <div class="controls">
            <button id="parseReceiptBtn">Parse Receipt</button>
            <button id="saveReceiptBtn"
                    class="button-secondary"
                    style="display: none;">Save Receipt</button>
            <button id="downloadReceiptBtn"
                    class="button-secondary"
                    style="display: none;">Download Receipt CSV</button>
            <button id="manageMappingsBtn"
                    class="button-secondary">Manage Translations</button>
            <div id="receiptLoader"
                 class="loader"></div>
        </div>

        <div id="receipt-status"
             class="status"></div>
    </div>

    <!-- Receipt Display Section -->
    <div id="receiptDisplaySection"
         class="section hidden">
        <h2 class="section-header">Parsed Receipt Items</h2>
        <div id="receiptItems"></div>
        <div class="receipt-summary">
            <div class="total">
                <span>Total:</span>
                <span id="receiptTotal">$0.00</span>
            </div>
        </div>
    </div>

    <!-- Translation Mappings Section -->
    <div id="translationSection"
         class="section hidden">
        <h2 class="section-header">Translation Mappings</h2>
        <div class="translation-mappings">
            <div id="mappingsList"></div>
            <div class="add-mapping">
                <input type="text"
                       id="newOriginal"
                       placeholder="Original text (e.g., PAIN.GRIL)">
                <input type="text"
                       id="newTranslation"
                       placeholder="Human readable (e.g., Grilled Bread)">
                <button id="addMappingBtn"
                        class="button-secondary">Add Mapping</button>
            </div>
        </div>
    </div>

    <div class="section">
        <h2 class="section-header">Upload CSV Files</h2>

        <div class="category-select-container">
            <label for="categoryList">Category List:</label>
            <select id="categoryList">
                <option value="">Loading category lists...</option>
            </select>
            <button id="refreshListsBtn"
                    class="button-secondary">Refresh Lists</button>
        </div>

        <div class="file-upload">
            <label class="file-upload-label"
                   for="transactionFile">Transactions CSV File:</label>
            <input type="file"
                   id="transactionFile"
                   accept=".csv" />
        </div>

        <div class="file-upload">
            <label class="file-upload-label"
                   for="sharedFile">Shared Transactions CSV File (optional):</label>
            <input type="file"
                   id="sharedFile"
                   accept=".csv" />
        </div>

        <div class="controls">
            <button id="parseBtn">Parse CSV Only</button>
            <button id="categorizeBtn">Categorize Transactions</button>
            <button id="downloadBtn"
                    class="button-secondary">Download Categorized CSV</button>
            <div id="loader"
                 class="loader"></div>
        </div>

        <div id="status"
             class="status"></div>
    </div>

    <div id="csvDataSection"
         class="section hidden">
        <h2 class="section-header">CSV Data</h2>
        <div class="table-container">
            <table id="csvDataTable"></table>
        </div>
    </div>

    <div id="categorizedSection"
         class="section hidden">
        <h2 class="section-header">Categorized Results</h2>
        <div class="table-container">
            <table id="categorizedTable"></table>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Get references to DOM elements
            const transactionFile = document.getElementById('transactionFile');
            const sharedFile = document.getElementById('sharedFile');
            const receiptFile = document.getElementById('receiptFile');
            const parseBtn = document.getElementById('parseBtn');
            const parseReceiptBtn = document.getElementById('parseReceiptBtn');
            const saveReceiptBtn = document.getElementById('saveReceiptBtn');
            const downloadReceiptBtn = document.getElementById('downloadReceiptBtn');
            const manageMappingsBtn = document.getElementById('manageMappingsBtn');
            const categorizeBtn = document.getElementById('categorizeBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const refreshListsBtn = document.getElementById('refreshListsBtn');
            const refreshUsersBtn = document.getElementById('refreshUsersBtn');
            const categoryList = document.getElementById('categoryList');
            const userList = document.getElementById('userList');
            const csvDataTable = document.getElementById('csvDataTable');
            const categorizedTable = document.getElementById('categorizedTable');
            const csvDataSection = document.getElementById('csvDataSection');
            const categorizedSection = document.getElementById('categorizedSection');
            const receiptDisplaySection = document.getElementById('receiptDisplaySection');
            const translationSection = document.getElementById('translationSection');
            const loader = document.getElementById('loader');
            const receiptLoader = document.getElementById('receiptLoader');
            const status = document.getElementById('status');
            const receiptStatus = document.getElementById('receipt-status');
            const userStatus = document.getElementById('user-status');

            let currentReceiptData = null;
            let translationMappings = new Map();

            // Load category lists on page load
            loadCategoryLists();
            loadUserList();
            loadTranslationMappings();

            // Refresh lists button
            refreshListsBtn.addEventListener('click', loadCategoryLists);
            refreshUsersBtn.addEventListener('click', loadUserList);

            // Manage mappings button
            manageMappingsBtn.addEventListener('click', function () {
                translationSection.classList.toggle('hidden');
                if (!translationSection.classList.contains('hidden')) {
                    loadTranslationMappings();
                }
            });

            // Parse button click handler
            parseBtn.addEventListener('click', async function () {
                if (!transactionFile.files.length) {
                    showStatus('Please select a transaction CSV file', 'error');
                    return;
                }

                try {
                    showLoader();
                    const data = await parseCSV();
                    displayCSVData(data.transactions);
                    hideLoader();
                    csvDataSection.classList.remove('hidden');
                    categorizedSection.classList.add('hidden');
                    showStatus(`Parsed ${data.transactions.length} transactions successfully`, 'success');
                } catch (error) {
                    hideLoader();
                    showStatus('Error parsing CSV: ' + error.message, 'error');
                }
            });

            // Categorize button click handler
            categorizeBtn.addEventListener('click', async function () {
                if (!transactionFile.files.length) {
                    showStatus('Please select a transaction CSV file', 'error');
                    return;
                }

                try {
                    showLoader();
                    const data = await categorizeCSV();
                    displayCSVData(data.transactions);
                    displayCategorizedData(data.categorized);
                    hideLoader();
                    csvDataSection.classList.remove('hidden');
                    categorizedSection.classList.remove('hidden');
                    showStatus('Transactions categorized successfully', 'success');
                } catch (error) {
                    hideLoader();
                    showStatus('Error categorizing transactions: ' + error.message, 'error');
                }
            });

            // Parse receipt button click handler
            parseReceiptBtn.addEventListener('click', async function () {
                if (!receiptFile.files.length) {
                    showReceiptStatus('Please select a receipt CSV file', 'error');
                    return;
                }

                try {
                    showReceiptLoader();
                    const parsed = await parseReceipt();
                    currentReceiptData = parsed;
                    displayReceiptData(parsed.data);
                    hideReceiptLoader();
                    receiptDisplaySection.classList.remove('hidden');
                    saveReceiptBtn.style.display = 'inline-block';
                    downloadReceiptBtn.style.display = 'inline-block';
                    showReceiptStatus('Receipt parsed successfully', 'success');
                } catch (error) {
                    hideReceiptLoader();
                    showReceiptStatus('Error parsing receipt: ' + error.message, 'error');
                }
            });

            // Save receipt button click handler
            saveReceiptBtn.addEventListener('click', async function () {
                if (!currentReceiptData) {
                    showReceiptStatus('No receipt data to save', 'error');
                    return;
                }

                try {
                    showReceiptLoader();
                    await saveReceipt(currentReceiptData);
                    hideReceiptLoader();
                    showReceiptStatus('Receipt saved successfully', 'success');
                } catch (error) {
                    hideReceiptLoader();
                    showReceiptStatus('Error saving receipt: ' + error.message, 'error');
                }
            });

            // Download receipt button click handler
            downloadReceiptBtn.addEventListener('click', function () {
                if (!currentReceiptData) {
                    showReceiptStatus('No receipt data to download', 'error');
                    return;
                }

                downloadReceiptCSV(currentReceiptData);
                showReceiptStatus('Receipt downloaded successfully', 'success');
            });

            // Add translation mapping button
            document.getElementById('addMappingBtn').addEventListener('click', async function () {
                const original = document.getElementById('newOriginal').value.trim();
                const translation = document.getElementById('newTranslation').value.trim();

                if (!original || !translation) {
                    alert('Please enter both original and translation text');
                    return;
                }

                try {
                    await addTranslationMapping(original, translation);
                    document.getElementById('newOriginal').value = '';
                    document.getElementById('newTranslation').value = '';
                    loadTranslationMappings();
                    showReceiptStatus('Translation mapping added successfully', 'success');
                } catch (error) {
                    showReceiptStatus('Error adding translation: ' + error.message, 'error');
                }
            });

            // Download button click handler
            downloadBtn.addEventListener('click', async function () {
                if (!transactionFile.files.length) {
                    showStatus('Please select a transaction CSV file', 'error');
                    return;
                }

                try {
                    showLoader();
                    await downloadCategorizedCSV();
                    hideLoader();
                    showStatus('CSV downloaded successfully', 'success');
                } catch (error) {
                    hideLoader();
                    showStatus('Error downloading CSV: ' + error.message, 'error');
                }
            });

            // Load category lists
            async function loadCategoryLists() {
                try {
                    const response = await fetch('/api/category-lists');
                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error);
                    }

                    categoryList.innerHTML = '<option value="">Use default categories</option>';
                    result.data.forEach(list => {
                        const option = document.createElement('option');
                        option.value = list._id || list.id;
                        option.textContent = list.name + (list.isDefault ? ' (Default)' : '');
                        categoryList.appendChild(option);
                    });
                } catch (error) {
                    showStatus('Error loading category lists: ' + error.message, 'error');
                }
            }

            // Load user list
            async function loadUserList() {
                try {
                    const response = await fetch('/api/users');
                    const result = await response.json();

                    if (!result.success) {
                        throw new Error(result.error);
                    }

                    userList.innerHTML = '<option value="">None</option>';
                    result.data.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user._id || user.id;
                        option.textContent = user.name;
                        userList.appendChild(option);
                    });
                } catch (error) {
                    showUserStatus('Error loading user lists: ' + error.message, 'error');
                }
            }

            // Load translation mappings
            async function loadTranslationMappings() {
                try {
                    const response = await fetch('/api/receipts/translations');
                    const result = await response.json();

                    if (result.success) {
                        translationMappings.clear();
                        const mappingsList = document.getElementById('mappingsList');
                        mappingsList.innerHTML = '';

                        result.data.forEach(mapping => {
                            translationMappings.set(mapping.original, mapping.translation);

                            const mappingItem = document.createElement('div');
                            mappingItem.className = 'mapping-item';
                            mappingItem.innerHTML = `
                                <span class="mapping-original">${mapping.original}</span>
                                <span class="mapping-arrow">→</span>
                                <span class="mapping-translation">${mapping.translation}</span>
                                <button class="mapping-delete button-danger" onclick="deleteTranslationMapping('${mapping._id}')">Delete</button>
                            `;
                            mappingsList.appendChild(mappingItem);
                        });
                    }
                } catch (error) {
                    console.error('Error loading translation mappings:', error);
                }
            }

            // Add translation mapping
            async function addTranslationMapping(original, translation) {
                const response = await fetch('/api/receipts/translations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ original, translation })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
            }

            // Delete translation mapping (make it global for onclick)
            window.deleteTranslationMapping = async function (id) {
                try {
                    const response = await fetch(`/api/receipts/translations/${id}`, {
                        method: 'DELETE'
                    });

                    if (!response.ok) {
                        throw new Error(`Error ${response.status}: ${response.statusText}`);
                    }

                    loadTranslationMappings();
                    showReceiptStatus('Translation mapping deleted', 'success');
                } catch (error) {
                    showReceiptStatus('Error deleting translation: ' + error.message, 'error');
                }
            };

            // Parse CSV files
            async function parseCSV() {
                const formData = new FormData();
                formData.append('transactions', transactionFile.files[0]);

                if (sharedFile.files.length) {
                    formData.append('shared', sharedFile.files[0]);
                }

                const response = await fetch('/api/transactions/parse-csv', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                return {
                    transactions: result.data.transactions,
                    shared: result.data.sharedTransactions
                };
            }

            // Categorize CSV files
            async function categorizeCSV() {
                const formData = new FormData();
                formData.append('transactions', transactionFile.files[0]);

                if (sharedFile.files.length) {
                    formData.append('shared', sharedFile.files[0]);
                }

                // Add selected category list if any
                if (categoryList.value) {
                    formData.append('categoryListId', categoryList.value);
                }

                const response = await fetch('/api/transactions/categorize-csv', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                // Also parse to get raw data
                const parseFormData = new FormData();
                parseFormData.append('transactions', transactionFile.files[0]);
                if (sharedFile.files.length) {
                    parseFormData.append('shared', sharedFile.files[0]);
                }

                const parseResponse = await fetch('/api/transactions/parse-csv', {
                    method: 'POST',
                    body: parseFormData
                });

                if (!parseResponse.ok) {
                    throw new Error(`Error ${parseResponse.status}: ${parseResponse.statusText}`);
                }

                const parseResult = await parseResponse.json();
                const result = await response.json();

                if (!result.success) {
                    throw new Error(result.error);
                }

                return {
                    transactions: parseResult.data.transactions,
                    categorized: result.data
                };
            }

            // Parse receipt
            async function parseReceipt() {
                const formData = new FormData();
                formData.append('receipt', receiptFile.files[0]);

                const response = await fetch('/api/receipts/parse-receipt-csv', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                return result;
            }

            function displayReceiptData(data) {
                if (!data || !Array.isArray(data)) {
                    document.getElementById('receiptItems').innerHTML = '<p>No receipt data available</p>';
                    return;
                }

                const receiptItems = document.getElementById('receiptItems');
                receiptItems.innerHTML = '';

                let total = 0;

                data.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'receipt-item';

                    const price = typeof item.price === 'number' ? item.price : 0;

                    if (item.readableDescription === 'TOTAL') {
                        total = price;
                    }

                    const originalDiv = document.createElement('div');
                    originalDiv.className = 'receipt-original';
                    originalDiv.textContent = item.originalText || '';

                    const readableDiv = document.createElement('div');
                    readableDiv.className = 'receipt-readable';
                    const input = document.createElement('input');
                    input.type = 'text';
                    input.id = `readable-${index}`;
                    input.value = item.readableDescription || '';
                    input.dataset.index = index;
                    input.addEventListener('change', (event) => {
                        updateReceiptItem(index, event.target.value);
                    });
                    readableDiv.appendChild(input);

                    const priceDiv = document.createElement('div');
                    priceDiv.className = 'receipt-price';
                    priceDiv.textContent = `$${price.toFixed(2)}`;

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = 'receipt-actions';
                    const button = document.createElement('button');
                    button.className = 'button-secondary';
                    button.textContent = 'Apply Translation';
                    button.addEventListener('click', () => {
                        applyTranslation(index, item.originalText);
                    });
                    actionsDiv.appendChild(button);

                    itemDiv.appendChild(originalDiv);
                    itemDiv.appendChild(readableDiv);
                    itemDiv.appendChild(priceDiv);
                    itemDiv.appendChild(actionsDiv);

                    receiptItems.appendChild(itemDiv);
                });

                document.getElementById('receiptTotal').textContent = `$${total.toFixed(2)}`;
            }

            // Update receipt item (make it global for onchange)
            window.updateReceiptItem = async function (index, newValue, translation) {
                try {
                    if (translation) {
                        translation.translation = newValue;
                        const response = await fetch(`/api/receipts/translations/${translation._id}`, {
                            method: "PUT",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ translation: newValue })
                        });
                        const result = await response.json();

                        if (result.success && result.data) {
                            if (currentReceiptData && currentReceiptData[index]) {
                                currentReceiptData[index].readableDescription = newValue;
                            }
                        } else {
                            showReceiptStatus('No translation found for this item', 'error');
                        }
                    }
                    translationMappings.translation = newValue;
                } catch (error) {
                    showReceiptStatus('Error applying translation: ' + error.message, 'error');
                }
            };

            // Apply translation to an item (make it global for onclick)
            window.applyTranslation = async function (index, originalText) {
                // First check local mappings

                const readable = document.getElementById(`readable-${index}`).value;

                // Try to get translation from server
                try {
                    const response = await fetch(`/api/receipts/translate?text=${encodeURIComponent(originalText)}`);
                    const result = await response.json();

                    if (result.success && result.translation) {
                        updateReceiptItem(index, readable, result.translation);
                    } else {
                        // Create a translation
                        const response = await fetch(`/api/receipts/translations`, {
                            method: "POST",
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                original: originalText,
                                translation: readable,
                                userId: null,
                            })
                        });
                        const result = await response.json();

                        if (result.success && result.translation) {
                            if (currentReceiptData && currentReceiptData[index]) {
                                currentReceiptData[index].readableDescription = newValue;
                            }
                        } else {
                            showReceiptStatus('Error creating translation for this item', 'error');
                        }
                    }
                } catch (error) {
                    showReceiptStatus('Error applying translation: ' + error.message, 'error');
                }
            };

            // Save receipt
            async function saveReceipt(data) {
                const userId = userList.value;

                const response = await fetch('/api/receipts/save', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        items: data,
                        userId: userId || null
                    })
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }
            }

            // Download receipt as CSV
            function downloadReceiptCSV(data) {
                const csvRows = [
                    ['Original Text', 'Description', 'Price'],
                    ...data.map(item => [
                        item.originalText || '',
                        item.readableDescription || '',
                        item.price || 0
                    ])
                ];

                const csvData = csvRows.map(row =>
                    row.map(cell =>
                        typeof cell === 'string' && cell.includes(',')
                            ? `"${cell}"`
                            : cell
                    ).join(',')
                ).join('\n');

                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `receipt_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }

            // Download categorized CSV
            async function downloadCategorizedCSV() {
                const formData = new FormData();
                formData.append('transactions', transactionFile.files[0]);

                if (sharedFile.files.length) {
                    formData.append('shared', sharedFile.files[0]);
                }

                // Add selected category list if any
                if (categoryList.value) {
                    formData.append('categoryListId', categoryList.value);
                }

                const response = await fetch('/api/transactions/categorize-csv', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`Error ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                if (!result.success) {
                    throw new Error(result.error);
                }

                // Create a download link for CSV data
                const csvData = result.data.map(row =>
                    row.map(cell =>
                        typeof cell === 'string' && cell.includes(',')
                            ? `"${cell}"`
                            : cell
                    ).join(',')
                ).join('\n');

                const blob = new Blob([csvData], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `categorized_transactions_${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            }

            // Display CSV data as a table
            function displayCSVData(transactions) {
                if (!transactions || transactions.length === 0) {
                    csvDataTable.innerHTML = '<tr><td>No data available</td></tr>';
                    return;
                }

                // Create headers
                let tableHTML = '<tr>';
                const headers = Object.keys(transactions[0]);
                headers.forEach(header => {
                    tableHTML += `<th>${header}</th>`;
                });
                tableHTML += '</tr>';

                // Create rows
                transactions.forEach(transaction => {
                    tableHTML += '<tr>';
                    headers.forEach(header => {
                        let value = transaction[header];
                        // Format currency values
                        if (typeof value === 'number' && (header === 'amount' || header === 'balance')) {
                            value = `$${value.toFixed(2)}`;
                        }
                        tableHTML += `<td>${value !== undefined ? value : ''}</td>`;
                    });
                    tableHTML += '</tr>';
                });

                csvDataTable.innerHTML = tableHTML;
            }

            // Display categorized data as a table
            function displayCategorizedData(categorized) {
                if (!categorized || categorized.length === 0) {
                    categorizedTable.innerHTML = '<tr><td>No categorized data available</td></tr>';
                    return;
                }

                let tableHTML = '';

                // Create table from categorized data
                categorized.forEach(row => {
                    tableHTML += '<tr>';
                    row.forEach(cell => {
                        tableHTML += `<td>${cell !== undefined ? cell : ''}</td>`;
                    });
                    tableHTML += '</tr>';
                });

                categorizedTable.innerHTML = tableHTML;
            }

            // Show loader
            function showLoader() {
                loader.style.display = 'inline-block';
                parseBtn.disabled = true;
                categorizeBtn.disabled = true;
                downloadBtn.disabled = true;
                refreshListsBtn.disabled = true;
            }

            // Hide loader
            function hideLoader() {
                loader.style.display = 'none';
                parseBtn.disabled = false;
                categorizeBtn.disabled = false;
                downloadBtn.disabled = false;
                refreshListsBtn.disabled = false;
            }

            // Show receipt loader
            function showReceiptLoader() {
                receiptLoader.style.display = 'inline-block';
                parseReceiptBtn.disabled = true;
                saveReceiptBtn.disabled = true;
                downloadReceiptBtn.disabled = true;
            }

            // Hide receipt loader
            function hideReceiptLoader() {
                receiptLoader.style.display = 'none';
                parseReceiptBtn.disabled = false;
                saveReceiptBtn.disabled = false;
                downloadReceiptBtn.disabled = false;
            }

            // Show status message
            function showStatus(message, type) {
                status.textContent = message;
                status.className = 'status ' + type;
                status.style.display = 'block';

                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        status.style.display = 'none';
                    }, 5000);
                }
            }

            // Show receipt status message
            function showReceiptStatus(message, type) {
                receiptStatus.textContent = message;
                receiptStatus.className = 'status ' + type;
                receiptStatus.style.display = 'block';

                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        receiptStatus.style.display = 'none';
                    }, 5000);
                }
            }

            // Show user status message
            function showUserStatus(message, type) {
                userStatus.textContent = message;
                userStatus.className = 'status ' + type;
                userStatus.style.display = 'block';

                // Auto-hide success messages after 5 seconds
                if (type === 'success') {
                    setTimeout(() => {
                        userStatus.style.display = 'none';
                    }, 5000);
                }
            }
        });
    </script>
</body>

</html>